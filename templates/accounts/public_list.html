{% extends 'base.html' %}

{% block title %}{{ profile_user.username }}'s Video List - {{ site_name }}{% endblock %}
{% block meta_description %}{{ profile_user.username }}'s video list on {{ site_name }}. {{ stats.total }} entries, {{ stats.completed }} completed. Mean score: {{ stats.mean_score|floatformat:1 }}{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.2) 0%, rgba(0, 0, 0, 0.8) 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .stats-bar {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--purple-light);
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .filter-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }

    .filter-tab {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: var(--bg-card);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .filter-tab:hover {
        background: rgba(147, 51, 234, 0.2);
        color: var(--purple-light);
    }

    .filter-tab.active {
        background: var(--purple-primary);
        color: white;
    }

    .list-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .list-table th {
        background: var(--bg-card);
        padding: 1rem;
        text-align: left;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--purple-primary);
    }

    .list-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(147, 51, 234, 0.1);
        vertical-align: middle;
    }

    .list-table tr:hover td {
        background: rgba(147, 51, 234, 0.05);
    }

    .video-thumb-small {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
    }

    .score-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .score-high { background: #22c55e; color: white; }
    .score-mid { background: #eab308; color: black; }
    .score-low { background: #6b7280; color: white; }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-watching { background: #3b82f6; color: white; }
    .status-completed { background: #22c55e; color: white; }
    .status-on_hold { background: #eab308; color: black; }
    .status-dropped { background: #ef4444; color: white; }
    .status-plan_to_watch { background: #6b7280; color: white; }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header">
    <div class="d-flex align-items-center gap-4">
        {% if profile.avatar %}
        <img src="{{ profile.avatar.url }}" alt="{{ profile_user.username }}"
             class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--purple-light);">
        {% else %}
        <div class="rounded-circle d-flex align-items-center justify-content-center"
             style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--purple-primary) 0%, var(--purple-dark) 100%); font-size: 2rem; color: white;">
            {{ profile_user.username.0|upper }}
        </div>
        {% endif %}

        <div>
            <h2 class="mb-1">{{ profile_user.username }}'s Video List</h2>
            <p class="text-secondary mb-0">
                <i class="bi bi-collection-play me-1"></i>{{ stats.total }} entries
                <span class="mx-2">|</span>
                <i class="bi bi-star me-1"></i>Mean Score: {{ stats.mean_score|floatformat:1 }}
            </p>
        </div>

        <div class="ms-auto">
            <a href="{% url 'accounts:public_profile' profile_user.username %}" class="btn btn-outline-purple">
                <i class="bi bi-person me-1"></i>View Profile
            </a>
            {% if is_own_list %}
            <a href="{% url 'videos:my_list' %}" class="btn btn-purple ms-2">
                <i class="bi bi-pencil me-1"></i>Edit List
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="d-flex justify-content-around flex-wrap">
        <div class="text-center px-3">
            <div class="stat-number">{{ stats.watching }}</div>
            <div class="stat-label">Watching</div>
        </div>
        <div class="text-center px-3">
            <div class="stat-number">{{ stats.completed }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="text-center px-3">
            <div class="stat-number">{{ stats.on_hold }}</div>
            <div class="stat-label">On Hold</div>
        </div>
        <div class="text-center px-3">
            <div class="stat-number">{{ stats.dropped }}</div>
            <div class="stat-label">Dropped</div>
        </div>
        <div class="text-center px-3">
            <div class="stat-number">{{ stats.plan_to_watch }}</div>
            <div class="stat-label">Plan to Watch</div>
        </div>
    </div>
</div>

<!-- Share Link (for own list) -->
{% if is_own_list %}
<div class="alert" style="background: rgba(147, 51, 234, 0.1); border: 1px solid var(--purple-light); border-radius: 12px;">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <strong><i class="bi bi-share me-2"></i>Share your list</strong>
            <p class="mb-0 small text-secondary">Anyone with this link can view your video list</p>
        </div>
        <div class="input-group" style="width: auto;">
            <input type="text" class="form-control form-control-sm" id="listUrl"
                   value="{{ request.scheme }}://{{ request.get_host }}{% url 'accounts:public_list' profile_user.username %}" readonly
                   style="background: var(--bg-secondary); border-color: rgba(147, 51, 234, 0.3); width: 300px;">
            <button class="btn btn-purple btn-sm" onclick="copyListUrl()">
                <i class="bi bi-clipboard"></i> Copy
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter Tabs -->
<div class="filter-tabs">
    <a href="?status=all" class="filter-tab {% if current_status == 'all' %}active{% endif %}">All ({{ stats.total }})</a>
    <a href="?status=watching" class="filter-tab {% if current_status == 'watching' %}active{% endif %}">Watching ({{ stats.watching }})</a>
    <a href="?status=completed" class="filter-tab {% if current_status == 'completed' %}active{% endif %}">Completed ({{ stats.completed }})</a>
    <a href="?status=on_hold" class="filter-tab {% if current_status == 'on_hold' %}active{% endif %}">On Hold ({{ stats.on_hold }})</a>
    <a href="?status=dropped" class="filter-tab {% if current_status == 'dropped' %}active{% endif %}">Dropped ({{ stats.dropped }})</a>
    <a href="?status=plan_to_watch" class="filter-tab {% if current_status == 'plan_to_watch' %}active{% endif %}">Plan to Watch ({{ stats.plan_to_watch }})</a>
</div>

<!-- Sort Options -->
<div class="d-flex justify-content-end mb-3">
    <select class="form-select form-select-sm"
        style="width: auto; background: var(--bg-card); border-color: rgba(147, 51, 234, 0.3);"
        onchange="window.location.href='?status={{ current_status }}&sort=' + this.value">
        <option value="-updated_at" {% if current_sort == '-updated_at' %}selected{% endif %}>Last Updated</option>
        <option value="-score" {% if current_sort == '-score' %}selected{% endif %}>Score (High to Low)</option>
        <option value="score" {% if current_sort == 'score' %}selected{% endif %}>Score (Low to High)</option>
        <option value="title" {% if current_sort == 'title' %}selected{% endif %}>Title (A-Z)</option>
        <option value="-title" {% if current_sort == '-title' %}selected{% endif %}>Title (Z-A)</option>
        <option value="-added_at" {% if current_sort == '-added_at' %}selected{% endif %}>Date Added</option>
    </select>
</div>

<!-- List Table -->
{% if entries %}
<div class="table-responsive">
    <table class="list-table">
        <thead>
            <tr>
                <th style="width: 50px;">#</th>
                <th style="width: 100px;">Image</th>
                <th>Title</th>
                <th style="width: 120px;">Status</th>
                <th style="width: 80px;">Score</th>
                <th style="width: 80px;">Source</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td class="text-secondary">{{ forloop.counter }}</td>
                <td>
                    <a href="{% if entry.source == 'redtube' %}/redtube/watch/{{ entry.video_id }}/{% elif entry.source == 'hentai' %}/hentai/watch/{{ entry.video_id }}/{% else %}/watch/{{ entry.video_id }}/{% endif %}">
                        <img src="{{ entry.thumbnail }}" alt="{{ entry.title }}" class="video-thumb-small">
                    </a>
                </td>
                <td>
                    <a href="{% if entry.source == 'redtube' %}/redtube/watch/{{ entry.video_id }}/{% elif entry.source == 'hentai' %}/hentai/watch/{{ entry.video_id }}/{% else %}/watch/{{ entry.video_id }}/{% endif %}"
                       class="text-decoration-none text-white">
                        <strong>{{ entry.title|truncatechars:60 }}</strong>
                    </a>
                    {% if entry.notes %}
                    <br><small class="text-secondary"><i class="bi bi-journal-text me-1"></i>{{ entry.notes|truncatechars:50 }}</small>
                    {% endif %}
                </td>
                <td>
                    <span class="status-badge status-{{ entry.status }}">{{ entry.get_status_display }}</span>
                </td>
                <td>
                    {% if entry.score %}
                    <span class="score-badge {% if entry.score >= 8 %}score-high{% elif entry.score >= 5 %}score-mid{% else %}score-low{% endif %}">
                        {{ entry.score }}
                    </span>
                    {% else %}
                    <span class="text-secondary">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.source == 'redtube' %}
                    <span class="badge" style="background: #dc2626;">RT</span>
                    {% elif entry.source == 'hentai' %}
                    <span class="badge" style="background: #ec4899;">HT</span>
                    {% else %}
                    <span class="badge" style="background: #9333ea;">EP</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if has_next or has_prev %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item">
            <a class="page-link" href="?status={{ current_status }}&sort={{ current_sort }}&page={{ entries.previous_page_number }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        <li class="page-item active">
            <span class="page-link">Page {{ entries.number }}</span>
        </li>
        {% if has_next %}
        <li class="page-item">
            <a class="page-link" href="?status={{ current_status }}&sort={{ current_sort }}&page={{ entries.next_page_number }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-list-ul display-1 text-secondary mb-3"></i>
    <h4 class="text-secondary">No entries found</h4>
    {% if current_status != 'all' %}
    <p class="text-muted">No videos with status "{{ current_status }}"</p>
    <a href="?status=all" class="btn btn-outline-purple">View All Entries</a>
    {% else %}
    <p class="text-muted">This list is empty</p>
    {% endif %}
</div>
{% endif %}

{% if is_own_list %}
<script>
function copyListUrl() {
    const input = document.getElementById('listUrl');
    input.select();
    document.execCommand('copy');

    // Show feedback
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    setTimeout(() => btn.innerHTML = originalHtml, 2000);
}
</script>
{% endif %}
{% endblock %}
